{
  "_schema": "app-spec-v1",
  "_version": "2025-Q4",
  "_type": "application_spec",
  "_language": "json",
  "_status": "ACTIVE",

  "metadata": {
    "name": "Motif Memory Manager",
    "module_id": "mmm.core",
    "runtime": { "python": ">=3.11", "frameworks": ["FastAPI", "pydantic"] },
    "license": "MIT"
  },

  "references": [
    { "id": "RFC-0005", "clause": "§3–§4" },
    { "id": "RFC-0006", "clause": "§3–§4" },
    { "id": "RFC-0007", "clause": "§2–§4" },
    { "id": "RFC-0008", "clause": "§2–§3" },
    { "id": "RFC-0009", "clause": "§5–§7" },
    { "id": "PDP-0001", "clause": "§3–§4" }
  ],

  "feature_flags": [
    { "name": "exchange", "default": true },
    { "name": "integrity", "default": true },
    { "name": "provenance", "default": true },
    { "name": "gliders", "default": false }
  ],

  "env": [
    { "key": "MMM_REEF_INDEX_PATH", "default": "index.REEF" },
    { "key": "MMM_REEF_SHARDS_GLOB", "default": "TheReefArchive-*.REEF" },
    { "key": "MMM_WINDOW_RADIUS", "default": 24 },
    { "key": "MMM_FEATURE_FLAGS", "default": "exchange,integrity,provenance,gliders" }
  ],

  "dataclasses": [
    { "name": "EvidenceWindow", "fields": [
      {"name":"file","type":"str"}, {"name":"start_line","type":"int"}, {"name":"end_line","type":"int"}
    ]},
    { "name": "CooccurResult", "fields": [
      {"name":"candidates","type":"list[str]"},
      {"name":"evidence","type":"list[EvidenceWindow]"}
    ]}
  ],

  "modules": [
    { "id": "mmm_reef_adapter", "title": "Reef Adapter" },
    { "id": "mmm_llm", "title": "LLM Orchestrator" }
  ],

  "interfaces": [
    { "module": "mmm_reef_adapter", "name": "ReefAdapter", "methods": [
      { "name": "list_modules", "inputs": [{"name":"reef_index_path","type":"str"}], "output": {"type":"list[object]"} },
      { "name": "list_motifs", "inputs": [{"name":"module_id","type":"str"},{"name":"reef_index_path","type":"str"}], "output": {"type":"list[object]"} },
      { "name": "find", "inputs": [{"name":"route","type":"object"}], "output": {"type":"object"} },
      { "name": "window", "inputs": [{"name":"file","type":"str"},{"name":"line","type":"int"},{"name":"radius","type":"int?"}], "output": {"type":"EvidenceWindow"} },
      { "name": "cooccur", "inputs": [
          {"name":"m1","type":"str"},{"name":"m2","type":"str"},
          {"name":"reef_shards_glob","type":"str"},
          {"name":"ema32_C","type":"float"},{"name":"alpha","type":"float"},
          {"name":"now_tick","type":"int"},{"name":"seen_set","type":"list[str]"}
        ], "output": {"type":"CooccurResult"} },
      { "name": "build_reflections", "inputs": [{"name":"strategy","type":"list[str]"},{"name":"limit","type":"int"}], "output": {"type":"object"} }
    ]},

    { "module": "mmm_llm", "name": "MMM_LLM", "methods": [
      { "name": "complete_dyad", "inputs": [{"name":"m1","type":"str"},{"name":"m2","type":"str"}], "output": {"type":"object"} }
    ]}
  ],

  "algorithms": [
    { "id": "A-reef-window", "module": "mmm_reef_adapter", "name": "window",
      "steps": [
        "R = clamp(radius or ENV.MMM_WINDOW_RADIUS, min=1, max=48)",
        "start = max(1, line - R); end = line + R",
        "return {file, start_line:start, end_line:end}"
      ]
    },
    { "id": "A-reef-cooccur", "module": "mmm_reef_adapter", "name": "cooccur",
      "steps": [
        "W = 2 * (alpha * EMA32(ema32_C))",
        "scan shards for (m1,m2) proximity; derive m3 candidates",
        "drop candidates seen within W ticks; update seen_set",
        "dedupe and stable-sort lexicographically; return {candidates,evidence}"
      ]
    },
    { "id": "A-llm-complete-dyad", "module": "mmm_llm", "name": "complete_dyad",
      "steps": [
        "query ReefAdapter via strategy order: ontology > file_reflections > index_cooccur",
        "choose first admissible m3; attach minimal evidence window",
        "return {m3, provenance, evidence?}"
      ]
    }
  ],

  "telemetry": [
    { "metric": "reef_index_modules_count", "unit": "count" },
    { "metric": "reef_shard_count", "unit": "count" },
    { "metric": "reef_reflections_cache_size", "unit": "count" },
    { "metric": "reef_cooccur_candidate_rate", "unit": "count/s" }
  ],

  "http": [
    { "method": "POST", "path": "/complete_dyad", "impl": "MMM_LLM.complete_dyad",
      "input": {"type":"object","fields":[{"name":"m1"},{"name":"m2"}]},
      "output": {"type":"object","fields":[{"name":"m3"},{"name":"provenance"},{"name":"evidence?"}]}
    }
  ],

  "invariants": [
    "Read-only Reef posture",
    "Evidence discipline: Reef outputs include {file,start_line,end_line}",
    "Deterministic stable sorts (lexicographic)",
    "ASCII keys on wire"
  ]
}
