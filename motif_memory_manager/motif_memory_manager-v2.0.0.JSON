{
  "_schema": "noor-header-v1",
  "_schema_version": "2025-Q4-canonical-header-v1",
  "_generated_by": "Noor Symbolic Agent Suite",
  "_generated_at": "<now>",
  "_type": "application_spec",
  "_pdp_layer": "layer_2",
  "_status": "DRAFT",
  "_language": "json",
  "_license": "MIT",

  "_symbolic_id": "application.mmm_app_001",
  "_version": "v2.0.0-draft",
  "_title": "Motif Memory Manager â€” L2 App (LLM Variant)",
  "_subtitle": "Capacity-first memory orchestration with Reef-guided recall and triad completion.",

  "_extends": [
    "RFC-0005",
    "RFC-0006",
    "RFC-0007",
    "RFC-0008",
    "RFC-0009",
    "PDP-0001",
    "RFC-CORE-006"
  ],

  "_rfc_dependencies": [
    "RFC-0005 Â§3â€“5 (temporal continuity, resurrection gates)",
    "RFC-0006 Â§3 (field geometry & alignment)",
    "RFC-0007 Â§2â€“3 (ontology format & Ïˆ-SHA3)",
    "RFC-0008 Â§4â€“6 (exchange envelope & trust curves)",
    "RFC-0009 Â§8â€“11 (telemetry, immune bounds)",
    "RFC-CORE-006 (Motif Memory Manager, canonical L1)"
  ],

  "consumes_inputs_from": [
    "NoorFastTimeCore.ticks",
    "LogicalAgentAT (optional evidence tags)",
    "SymbolicTaskEngine (queries, tasks)"
  ],

  "_field_alignment": {
    "respect_modes": ["Ïˆ-resonance@Îž", "Ïˆ-null@Îž", "Ïˆ-bind@Îž"],
    "prohibited_actions": [
      "prune-before-compress",
      "ontology-merge-without-RFC-0007-validate",
      "export-without-provenance"
    ]
  },

  "_poetic_cipher": "Let the archive point the way; memory is a path, not a pile.",

  "_file_layout": [
    {
      "file_name": "mmm_app_001.JSON",
      "purpose": "Application specification for the L2 MMM (LLM variant).",
      "contains": [
        "core components",
        "reef adapter contract",
        "api surface (local project mode)",
        "storage/config notes",
        "pseudocode suite"
      ]
    }
  ],

  "default_motif_tone": "ðŸ’¬ Flow",

  "program_name": [
    "mmm_llm.py",
    "mmm_reef_adapter.py"
  ],

  "runtime_targets": {
    "python": ">=3.11",
    "frameworks": ["FastAPI", "pydantic"],
    "optional": ["qdrant|faiss|annoy", "opentelemetry-otlp"]
  },

  "feature_flags": {
    "enable_exchange_envelope": true,
    "enable_integrity_checks": true,
    "enable_provenance_on_export": true,
    "enable_point_space_gliders": true,
    "glider_equivalence": "ON"
  },

  "reef_adapter": {
    "index_path": "index.REEF",
    "shards_glob": "TheReefArchive-*.REEF",
    "mtime_watch": true,
    "window_radius_lines": 24,
    "reflections_strategy": ["ontology", "file_reflections", "index_cooccur"],
    "reflections_limit": 50000
  },

  "storage_and_config": {
    "note": "Project-folder mode: minimal drivers; all persistence optional.",
    "env_keys": [
      "MMM_REEF_INDEX_PATH",
      "MMM_REEF_SHARDS_GLOB",
      "MMM_WINDOW_RADIUS",
      "MMM_FEATURE_FLAGS"
    ],
    "defaults": {
      "MMM_REEF_INDEX_PATH": "index.REEF",
      "MMM_REEF_SHARDS_GLOB": "TheReefArchive-*.REEF",
      "MMM_WINDOW_RADIUS": 24,
      "MMM_FEATURE_FLAGS": "exchange,integrity,provenance,gliders"
    },
    "tables_optional": {
      "reef_reflections": ["tenant_id", "m1", "m2", "m3", "support_count", "provenance", "first_seen_ts", "last_seen_ts", "PRIMARY (tenant_id,m1,m2)"]
    }
  },

  "api_surface": {
    "base": "/v1/mmm",
    "mode": "project_local",
    "auth": "none (project folder)",
    "endpoints": [
      {
        "path": "/reef/index",
        "method": "GET",
        "returns": "modules[], motifs[], anchors[]",
        "impl": "ReefIndexRouter"
      },
      {
        "path": "/reef/window",
        "method": "POST",
        "body": "{module_id, line, radius?}",
        "returns": "{snippet, start_line, end_line}",
        "impl": "ReefShardScanner"
      },
      {
        "path": "/reef/build_reflections",
        "method": "POST",
        "body": "{limit?, strategy?}",
        "returns": "{built, updated, skipped}",
        "impl": "ReefReflectionsCache"
      },
      {
        "path": "/recall/query",
        "method": "POST",
        "body": "{query, k=10, psi_field?}",
        "llm_controls": ["injection_filter", "context_budget", "source_tags"],
        "returns": "{items:[{text, source, confidence, timestamp}]}",
        "impl": "MMM_LLM.recall"
      },
      {
        "path": "/complete_dyad",
        "method": "POST",
        "body": "{m1, m2}",
        "returns": "{m3, provenance, evidence?}",
        "impl": "MMM_LLM.complete_dyad"
      },
      {
        "path": "/export/packet",
        "method": "POST",
        "body": "{kind:'metrics'|'bundle', body, provenance}",
        "envelope": ["Sigma_phase?", "Delta_hash?", "origin_hash?"],
        "returns": "{ok:true, envelope}",
        "impl": "ExportEnvelope"
      }
    ]
  },

  "index": [
    { "section": "1", "title": "Core Components" },
    { "section": "1.1", "title": "MMM_LLM â€” Memory Orchestrator (capacity-first)" },
    { "section": "1.2", "title": "ReefIndexRouter â€” module/motif/anchor resolver" },
    { "section": "1.3", "title": "ReefShardScanner â€” windowed snippet reader" },
    { "section": "1.4", "title": "ReefReflectionsCache â€” dyadâ†’m3 compiler" },
    { "section": "1.5", "title": "SeenSetGuard â€” Î”Ï„_phase replay window" },
    { "section": "1.6", "title": "CompressionEngine â€” compress-before-prune" },
    { "section": "1.7", "title": "ExportEnvelope â€” Î£/Î”/provenance on egress" },
    { "section": "1.8", "title": "LLMRecallController â€” budgets & injection defense" },

    { "section": "2", "title": "Pseudocode Requirements" },
    { "section": "2.1", "title": "Core Method Suite" },
    { "section": "2.2", "title": "Reef Adapter Methods" },
    { "section": "2.3", "title": "Observability (local gauges)" },

    { "section": "3", "title": "Project-Local API Contracts (FastAPI stubs)" },
    { "section": "4", "title": "Storage & Config (minimal, optional)" },
    { "section": "5", "title": "Compliance & Regeneration Constraints" }
  ],

  "sections": [
    {
      "id": 1,
      "title": "Core Components",
      "core_components": [
        {
          "id": 1.1,
          "title": "MMM_LLM â€” Memory Orchestrator (capacity-first)",
          "responsibilities": [
            "Recall with context budgets and evidence windows.",
            "Dyad completion via ordered strategy: ontology â†’ cache â†’ index_cooccur â†’ LLM (with evidence).",
            "Compression-before-prune; glider equivalence idempotence.",
            "Export with Î£/Î”/provenance when enabled."
          ],
          "notes": ["Bind strictly to RFC-CORE-006 invariants; never mutate L1 semantics."]
        },
        {
          "id": 1.2,
          "title": "ReefIndexRouter â€” module/motif/anchor resolver",
          "responsibilities": [
            "Parse index.REEF",
            "list_modules(), list_motifs(module_id), find({module_id,anchor})"
          ]
        },
        {
          "id": 1.3,
          "title": "ReefShardScanner â€” windowed snippet reader",
          "responsibilities": [
            "Stream shards; window(file,line,radius)",
            "cooccur(m1,m2) using [INDEX] + vicinity scan"
          ]
        },
        {
          "id": 1.4,
          "title": "ReefReflectionsCache â€” dyadâ†’m3 compiler",
          "responsibilities": [
            "Build/update dyad completions from ontology & co-occurrence",
            "Store provenance: ontology|file_reflections|index_cooccur"
          ]
        },
        {
          "id": 1.5,
          "title": "SeenSetGuard â€” Î”Ï„_phase replay window",
          "responsibilities": [
            "LRU seen_set; reject duplicates within 2Â·Î”Ï„_phase",
            "Counters for accepts/rejects"
          ]
        },
        {
          "id": 1.6,
          "title": "CompressionEngine â€” compress-before-prune",
          "responsibilities": [
            "Equivalence clustering; compute lawful_compression_ratio",
            "Emit metrics for capacity-first compliance"
          ]
        },
        {
          "id": 1.7,
          "title": "ExportEnvelope â€” Î£/Î”/provenance on egress",
          "responsibilities": [
            "Attach Sigma_phase, Delta_hash chain, origin_hash when flags enabled",
            "Fail-closed if required fields missing"
          ]
        },
        {
          "id": 1.8,
          "title": "LLMRecallController â€” budgets & injection defense",
          "responsibilities": [
            "Token budgets: max 8192, target 4096, reserve 512",
            "Strip control directives; tag source/confidence/timestamp"
          ]
        }
      ]
    },

    {
      "id": 2,
      "title": "Pseudocode Requirements",
      "subsections": [
        {
          "id": 2.1,
          "title": "Core Method Suite",
          "methods": [
            "recall(query, k=10, psi_field=None) -> items[]",
            "complete_dyad(m1, m2) -> {m3, provenance, evidence?}",
            "compress_snapshot() -> {ratio, clusters}",
            "export_packet(kind, body, provenance) -> {ok, envelope}"
          ]
        },
        {
          "id": 2.2,
          "title": "Reef Adapter Methods",
          "methods": [
            "list_modules() -> modules[]",
            "list_motifs(module_id) -> motifs[]",
            "find(route) -> {file, line}",
            "window(file, line, radius) -> {snippet}",
            "cooccur(m1, m2) -> {candidates:[m3], evidence:[]}",
            "build_reflections(limit?, strategy?) -> {built, updated, skipped}"
          ]
        },
        {
          "id": 2.3,
          "title": "Observability (local gauges)",
          "metrics": [
            "lawful_compression_ratio",
            "equivalence_efficiency",
            "reanchor_rate",
            "quarantine_count",
            "avg_replay_window_ticks",
            "glider_detected (if enabled)"
          ]
        }
      ]
    },

    {
      "id": 3,
      "title": "Project-Local API Contracts (FastAPI stubs)",
      "note": "No RBAC in project mode; endpoints are local developer tools.",
      "openapi": "autogen"
    },

    {
      "id": 4,
      "title": "Storage & Config (minimal, optional)",
      "notes": [
        "Reflections cache is optional; memory-only by default.",
        "If a table is present, persist (tenant_id,m1,m2)->m3 with support_count."
      ]
    },

    {
      "id": 5,
      "title": "Compliance & Regeneration Constraints",
      "final_remarks": [
        "Capacity-first: compress-before-prune is mandatory.",
        "All dyad completions must expose provenance.",
        "Reef operations are read-only; archive is never mutated.",
        "Glider equivalence ON â†’ idempotent promotions."
      ],
      "regeneration_constraints": {
        "required_files": ["mmm_llm.py", "mmm_reef_adapter.py"],
        "rfc_compliance_required": true,
        "source_code_access": "prohibited during regeneration",
        "motif_integrity": "No artificial mutation; evidence windows must be attachable."
      }
    }
  ]
}
